<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Калькулятор маршрутов | Форма введения маршрута</title>
    <link href="{{ url_for('lib', path='/bootstrap5/bootstrap.css') }}" rel="stylesheet">
    <style>
        .autocomplete-items {
            border: 1px solid #ced4da;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            position: absolute;
            width: 100%;
            z-index: 1000;
            background: white;
        }
        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
        }
        .autocomplete-item:hover {
            background-color: #e9ecef;
        }
        .position-relative {
            position: relative;
        }
        .alert-fixed {
            position: fixed;
            top: 20px;
            right: 20px;
            min-width: 300px;
            z-index: 1050;
        }
        .route-icon svg {
            stroke:#FFA500;
            fill:transparent;
        }
        .header-rates > div {
            display: table;
        }
        .header-rates > div > * {
            display: table-cell;
            vertical-align: middle;
            margin: 0 .5rem;
        }
    </style>
</head>
<body>
<header class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Калькулятор</a>
            <div class="collapse navbar-collapse" id="navbarNavAltMarkup"></div>
            <div class="navbar-nav">
            </div>
            <div class="header-rates">
                <div>
                    <object data="{{ url_for('res', path='/currency/USD.svg') }}" type="image/svg+xml"></object>
                    <span>{{ rates['USD'] }} ₽</span>
                </div>
                <div>
                    <object data="{{ url_for('res', path='/currency/EUR.svg') }}" type="image/svg+xml"></object>
                    <span>{{ rates['EUR'] }} ₽</span>
                </div>
            </div>
        </div>
    </nav>
</header>

<main class="container">
    <div class="my-5">
        <div class="card shadow-sm rounded-4 p-4">
            <h2 class="mb-4 text-center">Калькулятор маршрутов</h2>

            <!-- Сообщения для пользователя -->
            <div id="alertContainer" class="d-none"></div>

            <form id="calcForm">
                <div class="mb-3">
                    <label for="dispatchDate" class="form-label">Дата отгрузки</label>
                    <input type="date" class="form-control" id="dispatchDate" value="" required>
                    <div class="invalid-feedback">Пожалуйста, выберите дату</div>
                </div>

                <div class="mb-3 position-relative">
                    <label for="departure" class="form-label">Пункт отправки</label>
                    <input type="text" class="form-control" id="departure" placeholder="Выберите пункт отправки" autocomplete="off" required>
                    <div id="departureList" class="autocomplete-items d-none"></div>
                </div>
                <input type="hidden" id="departureId" name="departureId" value="">

                <div class="mb-3 position-relative">
                    <label for="destination" class="form-label">Пункт назначения</label>
                    <input type="text" disabled class="form-control" id="destination" placeholder="Выберите пункт назначения" autocomplete="off" required>
                    <div id="destinationList" class="autocomplete-items d-none"></div>
                </div>
                <input type="hidden" id="destinationId" name="destinationId" value="">

                <div class="mb-3">
                    <label for="containerType" class="form-label">Тип контейнера</label>
                    <select class="form-select" id="containerType" required>
                        <option selected disabled value="">Выберите тип контейнера</option>
                        <option value="20">20'DC</option>
                        <option value="40">40'HC</option>
                    </select>
                    <div class="invalid-feedback">Пожалуйста, выберите тип контейнера</div>
                </div>

                <div class="md-3 row">
                    <div class="col-md">
                        <label for="cargoWeight" class="form-label">Вес груза (т)</label>
                        <input type="number" class="form-control" id="cargoWeight" min="1" step="0.01" placeholder="Введите вес груза" required>
                        <div class="invalid-feedback">Пожалуйста, укажите вес груза.</div>
                    </div>

                    <div class="col-md">
                        <label for="currency" class="form-label">Валюта рассчета</label>
                        <select class="form-select" id="currency" required>
                            <option selected disabled value="">Выберите валюту</option>
                            <option value="USD">USD</option>
                            <option value="RUB">RUB</option>
                        </select>
                        <div class="invalid-feedback">Пожалуйста, выберите валюту.</div>
                    </div>
                </div>

                <p><hr>
                <div class="md-3">
                    <button type="submit" class="btn btn-primary w-100">Расcчитать!</button>
                </div>
            </form>
        </div>

        <div id="results" class="mt-4"></div>
    </div>
</main>

<script>
    const dispatchDateInput = document.getElementById('dispatchDate');
    const departureInput = document.getElementById('departure');
    const destinationInput = document.getElementById('destination');
    const departureHiddenInput = document.getElementById('departureId');
    const destinationHiddenInput = document.getElementById('destinationId');
    const cargoWeightInput = document.getElementById('cargoWeight');
    const containerTypeInput = document.getElementById('containerType');
    const currencyInput = document.getElementById('currency');

    dispatchDateInput.valueAsDate = dispatchDateInput.valueAsDate || new Date();
    dispatchDateInput.min = dispatchDateInput.min || dispatchDateInput.value;

    const departures = { data: JSON.parse('{{ points_from | tojson }}') };

    dispatchDateInput.addEventListener('input', async () => {
        if (!dispatchDateInput.validity.valid) return;
        const date = dispatchDateInput.value;
        const resp = await fetch(`/get_departures?date=${date}`);
        if (resp.ok) {
            departures.data = await resp.json();
            destinationInput.value = "";
            destinationHiddenInput.value = "";
            destinationInput.disabled = true;
        }
    });

    // examples
    const destinations = { data: {
        "Atyrau (Ex Guryev), Kazakhstan (KZGUW)": 'ok1',
        "Almaty, Kazakhstan (KZALA)": 'ok2',
        "Astana, Kazakhstan (KZNQZ)": 'ok3',
    }};

    function setupAutocomplete(inputId, listId, dataObj, hiddenInputId) {
        const input = document.getElementById(inputId);
        const hiddenInput = document.getElementById(hiddenInputId);
        const list = document.getElementById(listId);

        function autocompleteProcess() {
            const data = dataObj.data;
            const val = this.value.trim().toLowerCase();
            list.innerHTML = '';

            const filtered = Object.keys(data).filter(item => item.toLowerCase().includes(val));
            if (!filtered.length) {
                list.classList.add('d-none');
                return;
            }

            let selectedVal = null;

            filtered.forEach(item => {
                if (item.toLowerCase() === val.toLowerCase()) selectedVal = item;
                const div = document.createElement('div');
                div.textContent = item;
                div.setAttribute('data-item-id', data[item]);
                div.classList.add('autocomplete-item');
                div.addEventListener('mousedown', () => {
                    input.value = item;
                    hiddenInput.value = data[item];
                    input.classList.remove('is-invalid');
                    list.classList.add('d-none');
                });
                list.appendChild(div);
            });
            if (selectedVal) {
                input.value = selectedVal;
                hiddenInput.value = data[selectedVal];
            } else hiddenInput.value = '';

            list.classList.remove('d-none');
        }

        input.addEventListener('input', autocompleteProcess);
        input.addEventListener('focus', autocompleteProcess);

        input.addEventListener('blur', () => {
            setTimeout(() => list.classList.add('d-none'), 50);
        });
    }

    setupAutocomplete('departure', 'departureList', departures, 'departureId');
    setupAutocomplete('destination', 'destinationList', destinations, 'destinationId');

    function showGlobalAlert(message) {
        const container = document.getElementById('alertContainer');
        container.innerHTML = `<div class="alert alert-danger alert-fixed alert-dismissible fade show" role="alert">
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
    </div>`;
        container.classList.remove('d-none');

        setTimeout(() => {
            const alert = container.querySelector('.alert');
            if (alert) new bootstrap.Alert(alert).close();
        }, 3000);
    }

    const icons = {};

    fetch('/res/route-icons/sea.svg').then(res => res.text()).then(svg => icons.sea = svg);
    fetch('/res/route-icons/rail.svg').then(res => res.text()).then(svg => icons.rail = svg);
    fetch('/res/route-icons/truck.svg').then(res => res.text()).then(svg => icons.truck = svg);

    async function calculateAndRender(payload) {
        const response = await fetch('/calculate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
        });
        const data = await response.json();
        const container = document.getElementById('results');
        container.innerHTML = '';

        data.forEach(route => {
            const routeEl = document.createElement('div');
            routeEl.className = 'p-3 mb-4 border rounded shadow-sm';

            const segmentsHTML = route.segments.map(segment => {
                let svg = icons[segment.type] || '';

                const price = segment.price.map(p => `${p.sum.toLocaleString()} ${p.currency}`).join(', ');
                return `
                <div class="d-flex align-items-center my-2">
                    <div class="route-icon" style="width:30px;height:30px;margin-right:10px;">${svg}</div>
                    <div>
                        <div><strong>${segment.from.name}</strong> → <strong>${segment.to.name}</strong></div>
                        <div class="text-muted">${price}</div>
                    </div>
                </div>
            `;
            }).join('');

            const servicesHTML = route.services
                .filter(s => s.checked || s.isRequired)
                .map(service => {
                    const price = service.price.map(p => `${p.sum.toLocaleString()} ${p.currency}`).join(', ');
                    return `<div class="text-muted">• ${service.name}: ${price}</div>`;
                }).join('');

            routeEl.innerHTML = `
            <h5 class="mb-2">Ставка действует: ${new Date(route.dateFrom).toLocaleDateString()} — ${new Date(route.dateTo).toLocaleDateString()}</h5>
            <div class="mb-2">Условия: ${route.beginCond} - ${route.finishCond}</div>
            <div class="mb-3">Контейнер: ${route.containers.map(c => c.name).join(', ')}</div>
            ${segmentsHTML}
            <h6 class="mt-3">Дополнительные услуги</h6>
            ${servicesHTML}
            <button class="btn btn-primary mt-3">Оформить заявку</button>
        `;

            container.appendChild(routeEl);
        });
    }

    document.getElementById('calcForm').addEventListener('submit', function (e) {
        if (!this.checkValidity()) {
            // стандартная браузерная валидация
            return;
        }

        e.preventDefault();

        if (!departureHiddenInput.value || !destinationHiddenInput.value) {
            showGlobalAlert("Пожалуйста, выберите один из вариантов пункта А и пункта Б.");
            if (!departureHiddenInput.value) departureInput.classList.add('is-invalid');
            if (!destinationHiddenInput.value) destinationInput.classList.add('is-invalid');
            return;
        }

        // Если всё корректно
        departureInput.classList.remove('is-invalid');
        destinationInput.classList.remove('is-invalid');

        const payload = {
            dispatchDate: dispatchDateInput.value,
            departureId: departureHiddenInput.value,
            destinationId: destinationHiddenInput.value,
            cargoWeight: cargoWeightInput.value,
            containerType: containerTypeInput.value,
            currency: currencyInput.value,
        };

        calculateAndRender(payload);
        alert(`Form submitted!${JSON.stringify(payload)}`);
    });
</script>

<script src="{{ url_for('lib', path='/bootstrap5/bootstrap.bundle.js') }}"></script>
</body>
</html>
