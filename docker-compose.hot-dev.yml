services:
  ### DATABASE
  database:
    build:
      dockerfile: "local.Dockerfile"
      target: "database"
    environment:
      MARIADB_RANDOM_ROOT_PASSWORD: 1
      MARIADB_USER: "${DB_USER}"
      MARIADB_PASSWORD: "${DB_PASS}"
      MARIADB_DATABASE: "${DB_NAME}"
    volumes:
      - "./config/database/backups/:/backup:rw"
      - "./config/database/dev-version/:/docker-entrypoint-initdb.d:ro"
    expose:
      - 3306
    networks:
      local:
    entrypoint: [ "docker-entrypoint.sh", "mariadbd" ]
    healthcheck:
      test: >
        sh -c '
        mariadb-dump -u$${MARIADB_USER} -p$${MARIADB_PASSWORD} $${MARIADB_DATABASE} > /backup/last_dump.sql 2>/backup/dump_error.log;
        if [ $$? -eq 0 ]; then
        gzip /backup/last_dump.sql -c > /backup/$$(date -I)-dump.gz;
        rm /backup/last_dump.sql;
        exit 0;
        else
        exit 1;
        fi
        '
      interval: 30m
      retries: 3
  dbadmin:
    depends_on:
      - database
    build:
      dockerfile: "local.Dockerfile"
      target: "dbadmin"
    expose:
      - 80
    ports:
      - "${ADMINER_PORT}:80"
    networks:
      local:
    environment:
      PMA_HOST: "${DB_HOST}"
      PMA_PORT: 3306
      PMA_USER: "${DB_USER}"
      PMA_PASSWORD: "${DB_PASS}"

  ### BACK
  calculator:
    depends_on:
      - database
    build:
      dockerfile: "local.Dockerfile"
      target: "calculator"
    env_file:
      - ".env"
    volumes:
      - "./apps/backend/:/app/backend/:r"
    expose:
      - 8080
    networks:
      local:
    command:
      - "backend.main:app"
      - "--host"
      - "0.0.0.0"
      - "--port"
      - "8080"
      - "--reload"
  auth:
    build:
      dockerfile: "local.Dockerfile"
      target: "calculator"
    env_file:
      - ".env"
    volumes:
      - "./apps/auth/:/app/auth/:r"
    expose:
      - 8081
    networks:
      local:
    command:
      - "auth.main:app"
      - "--host"
      - "0.0.0.0"
      - "--port"
      - "8081"
      - "--reload"

  ### FRONT
  adminfront:
    build:
      dockerfile: "local.Dockerfile"
      target: "frontadmin"
    environment:
      - DANGEROUSLY_DISABLE_HOST_CHECK=true
      - PORT=${ADMIN_FRONT_PORT}
      - VITE_PUBLIC_URL=/admin
      - REACT_ROUTING_MAIN_SITE=/
    volumes:
      - "./apps/front-admin/public:/app/public:ro"
      - "./apps/front-admin/src:/app/src:ro"
      - "./apps/front-admin/index.html:/app/index.html:ro"
      - "./apps/front-admin/tsconfig.json:/app/tsconfig.json:ro"
      - "./apps/front-admin/eslint.config.mjs:/app/eslint.config.mjs:ro"
      - "./apps/front-admin/vite.config.js:/app/vite.config.js:ro"
    expose:
      - ${ADMIN_FRONT_PORT}
    ports:
      - "${ADMIN_FRONT_PORT}:${ADMIN_FRONT_PORT}"
    networks:
      local:
    command: ["start"]

  ### PROXY
  reverseproxy:
    depends_on:
      calculator:
        condition: service_started
      auth:
        condition: service_started
      adminfront:
        condition: service_started
    build:
      dockerfile: "local.Dockerfile"
      target: "reverseproxy"
    env_file:
      - ".env"
    restart: unless-stopped
    volumes:
      - "./config/nginx/conf/nginx-dev.conf.template:/etc/nginx/templates/default.conf.template:ro"
      - "./config/nginx/conf/mime.types:/etc/nginx/conf.d/mime.types:ro"
      - "./apps/frontend/:/www/frontend/:ro"
    networks:
      local:
    ports:
      - "${APP_PORT}:80"

networks:
  local:
